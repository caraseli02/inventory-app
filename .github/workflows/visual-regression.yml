name: Visual Regression Testing

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  check-trigger:
    name: Check Visual Test Trigger
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      (contains(github.event.comment.body, '/visual-test') || contains(github.event.comment.body, '/vrt'))
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}

    steps:
      - name: Check if trigger is valid
        id: check
        run: |
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "Visual regression test triggered by comment"

      - name: Add reaction to comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: eyes

  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            return issue.data;

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: pnpm build
        env:
          VITE_SUPABASE_URL: 'https://mock.supabase.co'
          VITE_SUPABASE_PUBLISHABLE_KEY: 'mock-key'

      - name: Download baseline screenshots
        id: download-baseline
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: visual-baseline
          path: tests/visual-baseline/

      - name: Run visual regression tests
        id: visual-test
        run: |
          # Create directories
          mkdir -p tests/visual-baseline tests/visual-current tests/visual-diff

          # Start preview server in background
          pnpm preview --port 5173 &
          SERVER_PID=$!

          # Wait for server to be ready
          npx wait-on http://localhost:5173 -t 30000

          # Run visual regression script
          npx playwright test --config=playwright.visual.config.ts || true

          # Stop server
          kill $SERVER_PID || true

          # Check if there are differences
          if [ -d "tests/visual-diff" ] && [ "$(ls -A tests/visual-diff)" ]; then
            echo "has_differences=true" >> $GITHUB_OUTPUT
            echo "Visual differences detected!"
          else
            echo "has_differences=false" >> $GITHUB_OUTPUT
            echo "No visual differences detected."
          fi
        env:
          CI: true
          VITE_SUPABASE_URL: 'https://mock.supabase.co'
          VITE_SUPABASE_PUBLISHABLE_KEY: 'mock-key'

      - name: Upload current screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-current-${{ github.event.issue.number }}
          path: tests/visual-current/
          retention-days: 7

      - name: Upload diff screenshots
        if: always() && steps.visual-test.outputs.has_differences == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: visual-diff-${{ github.event.issue.number }}
          path: tests/visual-diff/
          retention-days: 7

      - name: Comment results on PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const hasDiff = '${{ steps.visual-test.outputs.has_differences }}' === 'true';
            const body = hasDiff
              ? `## üì∏ Visual Regression Test Results\n\n‚ö†Ô∏è **Visual differences detected!**\n\nScreenshots with differences have been uploaded as artifacts:\n- [Download current screenshots](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n- [Download diff images](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\nPlease review the differences and verify they are intentional.`
              : `## üì∏ Visual Regression Test Results\n\n‚úÖ **No visual differences detected!**\n\nAll screenshots match the baseline.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Add success reaction
        if: steps.visual-test.outputs.has_differences == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: '+1'

      - name: Add warning reaction
        if: steps.visual-test.outputs.has_differences == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: confused

  update-baseline:
    name: Update Visual Baseline
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      (contains(github.event.comment.body, '/update-baseline') || contains(github.event.comment.body, '/approve-visual'))

    steps:
      - name: Add reaction to comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: rocket

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: pnpm build
        env:
          VITE_SUPABASE_URL: 'https://mock.supabase.co'
          VITE_SUPABASE_PUBLISHABLE_KEY: 'mock-key'

      - name: Capture new baseline
        run: |
          mkdir -p tests/visual-baseline
          pnpm preview --port 5173 &
          SERVER_PID=$!
          npx wait-on http://localhost:5173 -t 30000
          npx playwright test --config=playwright.visual.config.ts --update-snapshots || true
          kill $SERVER_PID || true
        env:
          CI: true
          VITE_SUPABASE_URL: 'https://mock.supabase.co'
          VITE_SUPABASE_PUBLISHABLE_KEY: 'mock-key'

      - name: Upload new baseline
        uses: actions/upload-artifact@v4
        with:
          name: visual-baseline
          path: tests/visual-baseline/
          retention-days: 30

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## üé® Visual Baseline Updated\n\n‚úÖ New baseline screenshots have been captured and uploaded.\n\nFuture visual regression tests will compare against these new screenshots.'
            });
