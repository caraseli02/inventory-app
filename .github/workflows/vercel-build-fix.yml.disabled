name: Auto-fix Vercel Build Failures

on:
  # Trigger when a deployment status is created or updated
  deployment_status:

  # Also trigger on check runs (Vercel creates check runs for builds)
  check_run:
    types: [completed]

  # Fallback: trigger on workflow run failures
  workflow_run:
    workflows: ["*"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read
  deployments: read

jobs:
  detect-vercel-failure:
    runs-on: ubuntu-latest
    # Only run if the check/deployment failed
    if: |
      (github.event.deployment_status.state == 'failure') ||
      (github.event.check_run.conclusion == 'failure' && github.event.check_run.app.name == 'Vercel') ||
      (github.event.workflow_run.conclusion == 'failure')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          fetch-depth: 0

      - name: Get Vercel deployment logs
        id: get-logs
        run: |
          # Try to extract deployment URL and logs
          if [ "${{ github.event.deployment_status.target_url }}" != "" ]; then
            echo "deployment_url=${{ github.event.deployment_status.target_url }}" >> $GITHUB_OUTPUT
          fi

          # Get the check run URL if available
          if [ "${{ github.event.check_run.html_url }}" != "" ]; then
            echo "check_url=${{ github.event.check_run.html_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Claude Code to fix build
        uses: anthropics/claude-code-action@v1
        with:
          # Use Anthropic API (or configure for Bedrock/Vertex AI)
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Automation mode with predefined prompt
          prompt: |
            ðŸš¨ **Vercel Build Failed**

            A Vercel deployment has failed on branch `${{ github.ref_name }}`.

            **Your task:**
            1. Read the recent commits and identify what changes were made
            2. Check the build configuration in `vite.config.ts`, `package.json`, and `tsconfig.json`
            3. Look for common Vercel build issues:
               - TypeScript errors (run `pnpm build` locally)
               - Missing environment variables
               - Import/export errors
               - Dependency issues
            4. Fix the build errors
            5. Commit the fixes with message: "fix: Resolve Vercel build failure"
            6. Push to the branch: `${{ github.ref_name }}`

            **Context:**
            - Deployment URL: ${{ steps.get-logs.outputs.deployment_url }}
            - Check URL: ${{ steps.get-logs.outputs.check_url }}
            - Branch: `${{ github.ref_name }}`
            - Commit: ${{ github.sha }}

            **Important:** Follow the project's CLAUDE.md guidelines and ensure all changes pass `pnpm build` before committing.

          # Allow the action to make commits
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Enable all tools needed for debugging and fixing
          tools: |
            read
            write
            edit
            bash
            glob
            grep

          # Set working directory
          working_directory: .

      - name: Comment on PR with fix attempt
        if: github.event.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ¤– Claude Code has been triggered to automatically fix the Vercel build failure. Check the action logs for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            })
